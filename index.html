<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Abre généalogique FaëriX</title>

  <style>
    .node circle {
      cursor: pointer;
      fill: #fff;
      stroke-width: 3px;
    }

    .node text {
      font: 12px sans-serif;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 2px;
    }
  </style>
</head>

<body>
  <script src="https://cdn.jsdelivr.net/lodash/4.6.1/lodash.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>

  <script>
    function treeify(data) {
      var dataMap = data.reduce(function(map, node) {
        var n = node.name.toLowerCase();
        map[n] = node;
        return map;
      }, {});

      data.forEach(function(node) {
          node.children = _.chain(node.children || [])
            .map(function(k) {
              k = k.toLowerCase()
              if(dataMap[k]) {
                var v = dataMap[k]
                delete dataMap[k]
                return v
              } else {
                console.log("Unknown node :", k);
                return undefined
              }
            })
            .filter()
            .value()
      });

      return {"name": "__", "children": _.values(dataMap)};
    }

    function zoom(svg) {
      return d3.behavior.zoom()
        .scaleExtent([0.2, 3])
        .on("zoom", function() {
          svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        });
    }

    function flatten(root) {
      var nodes = []
      function aux(x) {
        nodes.push(x)
        x.children.forEach(aux)
      }
      aux(root)
      return nodes
    }
    function treeLinks(nodes) {
      links = []
      nodes.forEach(function(x) {
        x.children.forEach(function(y) {
          links.push({"source":x,"target":y})
        })
      })
      return links
    }

    // ************** Generate the tree diagram	 *****************
    var colors = {
      "prez": "red",
      "vice": "orange",
      "trez": "blue",
      "conv": "brown",
      // "relex": "",
      // "web": "",
      // "com": "",
      // "pjc": "",
      // "asphalte": "",
      // "touriste": "",
      // "magic": "",
      // "ami": "",
      // "neverseen": "",
    }
    var margin = { top: 20, right: 120, bottom: 20, left: 120 }
    var width = $(document).width() - margin.right - margin.left
    var height = $(document).height() - margin.top - margin.bottom
    var duration = 750

    // d3.select(self.frameElement).style("height", "780px");

    var diagonal = d3.svg.diagonal();

    // var tree = d3.layout.tree()
    //   .separation(function(a, b) {
    //     return a.parent == b.parent ? 8 : 10;
    //   })
    //   .size([width, height]);

    var force = d3.layout.force()
        .charge(function(n) {
            return -200;
        })
        .friction(0.95)
        .gravity(0.02)
        .linkStrength(0.2)
        .linkDistance(function(l) {
            return 30;
        })
        .size([width, height]);

    var drag = force.drag()
        .on("dragstart", function() {
          d3.event.sourceEvent.stopPropagation();
        });


    var baseSvg = d3.select("body").append("svg")
      .attr("width", width + margin.right + margin.left)
      .attr("height", height + margin.top + margin.bottom)
      .attr("class", "overlay")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    var svg = baseSvg
      .append("g")

    baseSvg.call(zoom(svg))


    var initTree = function(data) {
      var root = treeify(data);
      root.promo = 1950;

      function isNotRoot(d) { return d.name != "__"; }

      var node, link
      force.on("tick", function(){
        force.nodes().forEach(function(d) {
          if (!d.fixed) {
            var r = 10 + 4, dx, dy, ly = 50;

            // #1: constraint all nodes to the visible screen:
            //d.x = Math.min(width - r, Math.max(r, d.x));
            //d.y = Math.min(height - r, Math.max(r, d.y));

            // #1.0: hierarchy: same level nodes have to remain with a 1 LY band vertically:
            if (d.children || d._children) {
              var py = 0;
              // if (d.parent) {
              //   py = d.parent.y;
              // }
              d.y = py + (d.promo - 2000) * ly + r;
              d.py = d.y
            }

            // #1a: constraint all nodes to the visible screen: links
            // dx = Math.min(0, width - r - d.x) + Math.max(0, r - d.x);
            // dy = Math.min(0, height - r - d.y) + Math.max(0, r - d.y);
            // d.x += 2 * Math.max(-ly, Math.min(ly, dx));
            // d.y += 2 * Math.max(-ly, Math.min(ly, dy));
            // // #1b: constraint all nodes to the visible screen: charges ('repulse')
            // dx = Math.min(0, width - r - d.px) + Math.max(0, r - d.px);
            // dy = Math.min(0, height - r - d.py) + Math.max(0, r - d.py);
            // d.px += 2 * Math.max(-ly, Math.min(ly, dx));
            // d.py += 2 * Math.max(-ly, Math.min(ly, dy));

            // #2: hierarchy means childs must be BELOW parents in Y direction:
            // if (d.parent) {
            //   d.y = Math.max(d.y, d.parent.y + ly);
            //   d.py = Math.max(d.py, d.parent.py + ly);
            // }
          }
        });

        link.attr("d", diagonal);

        node.attr("transform", function(d) {
          return 'translate(' + [d.x, d.y] + ')';
        });
      })

      var id = 0
      var click
      var update = function(source) {
        var nodes = flatten(root)
        var links = treeLinks(nodes)

        force
            .nodes(nodes)
            .links(links)
            .start();
        // nodes = _.filter(nodes, isNotRoot)
        // links = _.filter(links, function(l) { return isNotRoot(l.source); })


        // nodes.forEach(function(d) { d.y = (d.promo - 2000) * 50; });

        node = svg.selectAll("g.node")
          .data(nodes, function(d) { return d.id || (d.id = ++id); });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter()
          .append("g")
          .attr("class", "node")
          .attr("transform", function(d) {
            return "translate(" + source.x0 + "," + source.y0 + ")";
          })
          ;


        nodeEnter.append("circle")
          .attr("r", 1e-6)
          .style("stroke", function(d) {
            return colors[d.respo] || "black";
          })
          .style("fill", function(d) {
            return d._children ? "lightsteelblue" : "#fff";
          })
          .call(drag)
          .on("click", click)
          ;

        nodeEnter.append("text")
          .attr("y", 22)
          .attr("text-anchor", "middle")
          .text(function(d) { return d.name; })
          .style("fill-opacity", 1e-6)
          .append("svg:title")
          .text(function(d) {
            return (d.real_name ? d.real_name : "?") + " (" + d.promo + ")";
          })
          ;


        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
          // .duration(duration)
          .attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          });

        nodeUpdate.select("circle")
          .attr("r", 10)
          .style("fill", function(d) {
            return d._children ? "lightsteelblue" : "#fff";
          });

        nodeUpdate.select("text")
          .style("fill-opacity", 1);


        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
          // .duration(duration)
          .attr("transform", function(d) {
            return "translate(" + source.x + "," + source.y + ")";
          })
          .remove();

        nodeExit.select("circle")
          .attr("r", 1e-6);

        nodeExit.select("text")
          .style("fill-opacity", 1e-6);



        // Update the links…
        link = svg.selectAll("path.link")
          .data(links, function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter()
          .insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
            var o = { x: source.x0, y: source.y0 };
            return diagonal({
              source: o,
              target: o
            });
          });

        // Transition links to their new position.
        link.transition()
          // .duration(duration)
          .attr("d", diagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
          // .duration(duration)
          .attr("d", function(d) {
            return diagonal({ source: source, target: source });
          })
          .remove();


        // Stash the old positions for transition.
        nodes.forEach(function(d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });
      }

      // Toggle children on click.
      click = function(d) {
        if (d3.event.defaultPrevented) return; // click suppressed
        if (d.children && d.children.length > 0) {
          d._children = d.children;
          d.children = [];
        } else {
          d.children = d._children;
          d._children = [];
        }
        update(d);
      }

      update(root);
    }


  </script>
  <script>
    d3.csv("faerix.csv")
      .row(function(d) {
        d.promo = +d.promo
        d.children = d.children == "" ? [] : d.children.split(";")
        return d
      })
      .get(function(error, rows) {
        initTree(rows)
      });
  </script>

</body>

</html>
